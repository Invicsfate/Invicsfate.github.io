<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"invicsfate.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
<meta property="og:type" content="website">
<meta property="og:title" content="Invicsfate">
<meta property="og:url" content="http://Invicsfate.github.io/index.html">
<meta property="og:site_name" content="Invicsfate">
<meta property="og:description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Invicsfate">
<meta name="twitter:description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">

<link rel="canonical" href="http://Invicsfate.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>Invicsfate</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Invicsfate</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">菜狗.jpg</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/09/01/minhook源码简析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/01/minhook源码简析/" class="post-title-link" itemprop="url">minhook源码简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-01 00:41:11 / Modified: 10:46:14" itemprop="dateCreated datePublished" datetime="2020-09-01T00:41:11+08:00">2020-09-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="minhook源码简析"><a href="#minhook源码简析" class="headerlink" title="minhook源码简析"></a>minhook源码简析</h1><p>minhook的一般使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (MH_Initialize() != MH_OK)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (MH_CreateHook(pTarget, pDetour, ppOriginal) != MH_OK) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (MH_EnableHook(pTarget) != MH_OK) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>本文简单分析了32位minhook源代码在实现hook时的一些关键核心点，主要分析的也是上述三个函数，主要核心点如下(一些关键性注释已经在源码中使用中说明)：</p>
<ul>
<li>minhook中的数据结构使用</li>
<li>反汇编hook处代码，建立trampoline</li>
<li>进行hook时的多线程安全性保证</li>
</ul>
<h3 id="MH-Initialize"><a href="#MH-Initialize" class="headerlink" title="MH_Initialize"></a>MH_Initialize</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MH_STATUS WINAPI <span class="title">MH_Initialize</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MH_STATUS status = MH_OK;</span><br><span class="line"></span><br><span class="line">    EnterSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_hHeap == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建供进程使用的全局堆对象</span></span><br><span class="line">        g_hHeap = HeapCreate(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (g_hHeap != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Initialize the internal function buffer.</span></span><br><span class="line">            InitializeBuffer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            status = MH_ERROR_MEMORY_ALLOC;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        status = MH_ERROR_ALREADY_INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LeaveSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EnterSpinLock"><a href="#EnterSpinLock" class="headerlink" title="EnterSpinLock"></a>EnterSpinLock</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VOID <span class="title">EnterSpinLock</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SIZE_T spinCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait until the flag is FALSE.</span></span><br><span class="line">    <span class="keyword">while</span> (InterlockedCompareExchange(&amp;g_isLocked, TRUE, FALSE) != FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// No need to generate a memory barrier here, since InterlockedCompareExchange()</span></span><br><span class="line">        <span class="comment">// generates a full memory barrier itself.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prevent the loop from being too busy.</span></span><br><span class="line">        <span class="keyword">if</span> (spinCount &lt; <span class="number">32</span>)</span><br><span class="line">            Sleep(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            Sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        spinCount++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InterlockedCompareExchange用于创建锁，保证当前只能一个线程能执行while之后的操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Spin lock flag for EnterSpinLock()/LeaveSpinLock().</span></span><br><span class="line"><span class="keyword">volatile</span> LONG g_isLocked = FALSE;</span><br></pre></td></tr></table></figure>
<p>在循环中放置Sleep函数，防止循环过快。</p>
<h4 id="LeaveSpinLock"><a href="#LeaveSpinLock" class="headerlink" title="LeaveSpinLock"></a>LeaveSpinLock</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VOID <span class="title">LeaveSpinLock</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// No need to generate a memory barrier here, since InterlockedExchange()</span></span><br><span class="line">    <span class="comment">// generates a full memory barrier itself.</span></span><br><span class="line"></span><br><span class="line">    InterlockedExchange(&amp;g_isLocked, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>恢复锁的值为FALSE</p>
<h4 id="InitializeBuffer"><a href="#InitializeBuffer" class="headerlink" title="InitializeBuffer"></a>InitializeBuffer</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">InitializeBuffer</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Nothing to do for now.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UnintializeBuffer"><a href="#UnintializeBuffer" class="headerlink" title="UnintializeBuffer"></a>UnintializeBuffer</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">UninitializeBuffer</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PMEMORY_BLOCK pBlock = g_pMemoryBlocks;</span><br><span class="line">    g_pMemoryBlocks = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pBlock)</span><br><span class="line">    &#123;</span><br><span class="line">        PMEMORY_BLOCK pNext = pBlock-&gt;pNext;</span><br><span class="line">        VirtualFree(pBlock, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        pBlock = pNext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MH-CreateHook"><a href="#MH-CreateHook" class="headerlink" title="MH_CreateHook"></a>MH_CreateHook</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MH_STATUS WINAPI <span class="title">MH_CreateHook</span><span class="params">(LPVOID pTarget, LPVOID pDetour, LPVOID *ppOriginal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MH_STATUS status = MH_OK;</span><br><span class="line"></span><br><span class="line">    EnterSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_hHeap != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsExecutableAddress(pTarget) &amp;&amp; IsExecutableAddress(pDetour))</span><br><span class="line">        &#123;</span><br><span class="line">            UINT pos = FindHookEntry(pTarget);</span><br><span class="line">            <span class="keyword">if</span> (pos == INVALID_HOOK_POS)</span><br><span class="line">            &#123;</span><br><span class="line">                LPVOID pBuffer = AllocateBuffer(pTarget);</span><br><span class="line">                <span class="keyword">if</span> (pBuffer != <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    TRAMPOLINE ct;</span><br><span class="line"></span><br><span class="line">                    ct.pTarget     = pTarget;</span><br><span class="line">                    ct.pDetour     = pDetour;</span><br><span class="line">                    ct.pTrampoline = pBuffer;</span><br><span class="line">                    <span class="keyword">if</span> (CreateTrampolineFunction(&amp;ct))</span><br><span class="line">                    &#123;</span><br><span class="line">                        PHOOK_ENTRY pHook = AddHookEntry();</span><br><span class="line">                        <span class="keyword">if</span> (pHook != <span class="literal">NULL</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            pHook-&gt;pTarget     = ct.pTarget;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">                            pHook-&gt;pDetour     = ct.pRelay;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                            pHook-&gt;pDetour     = ct.pDetour;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                            pHook-&gt;pTrampoline = ct.pTrampoline;</span><br><span class="line">                            pHook-&gt;patchAbove  = ct.patchAbove;</span><br><span class="line">                            pHook-&gt;isEnabled   = FALSE;</span><br><span class="line">                            pHook-&gt;queueEnable = FALSE;</span><br><span class="line">                            pHook-&gt;nIP         = ct.nIP;</span><br><span class="line">                            <span class="built_in">memcpy</span>(pHook-&gt;oldIPs, ct.oldIPs, ARRAYSIZE(ct.oldIPs));</span><br><span class="line">                            <span class="built_in">memcpy</span>(pHook-&gt;newIPs, ct.newIPs, ARRAYSIZE(ct.newIPs));</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// Back up the target function.</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ct.patchAbove)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">memcpy</span>(</span><br><span class="line">                                    pHook-&gt;backup,</span><br><span class="line">                                    (LPBYTE)pTarget - <span class="keyword">sizeof</span>(JMP_REL),</span><br><span class="line">                                    <span class="keyword">sizeof</span>(JMP_REL) + <span class="keyword">sizeof</span>(JMP_REL_SHORT));</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">memcpy</span>(pHook-&gt;backup, pTarget, <span class="keyword">sizeof</span>(JMP_REL));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ppOriginal != <span class="literal">NULL</span>)</span><br><span class="line">                                *ppOriginal = pHook-&gt;pTrampoline;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            status = MH_ERROR_MEMORY_ALLOC;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        status = MH_ERROR_UNSUPPORTED_FUNCTION;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (status != MH_OK)</span><br><span class="line">                    &#123;</span><br><span class="line">                        FreeBuffer(pBuffer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    status = MH_ERROR_MEMORY_ALLOC;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                status = MH_ERROR_ALREADY_CREATED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            status = MH_ERROR_NOT_EXECUTABLE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        status = MH_ERROR_NOT_INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LeaveSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先对传入参数进行检查，检查hook地址是否属于可执行内存</p>
<h4 id="IsExecutableAddress"><a href="#IsExecutableAddress" class="headerlink" title="IsExecutableAddress"></a>IsExecutableAddress</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">IsExecutableAddress</span><span class="params">(LPVOID pAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MEMORY_BASIC_INFORMATION mi;</span><br><span class="line">    VirtualQuery(pAddress, &amp;mi, <span class="keyword">sizeof</span>(mi));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (mi.State == MEM_COMMIT &amp;&amp; (mi.Protect &amp; PAGE_EXECUTE_FLAGS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着判断hook地址是否已经hook</p>
<h4 id="FindHookEntry"><a href="#FindHookEntry" class="headerlink" title="FindHookEntry"></a>FindHookEntry</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> UINT <span class="title">FindHookEntry</span><span class="params">(LPVOID pTarget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UINT i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; g_hooks.size; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ULONG_PTR)pTarget == (ULONG_PTR)g_hooks.pItems[i].pTarget)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> INVALID_HOOK_POS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果被hook，返回保存的HOOK_ENTRY结构体下标；反之进行hook，返回INVALID_HOOK_POS.</p>
<h4 id="AllocateBuffer-minhook中的数据结构使用"><a href="#AllocateBuffer-minhook中的数据结构使用" class="headerlink" title="AllocateBuffer(minhook中的数据结构使用)"></a>AllocateBuffer(minhook中的数据结构使用)</h4><p>程序在初始化时，构造了MEMORY_BLOCK和MEMORY_SLOT两个单向链表，MEMORY_SLOT单向链表在MEMORY_BLOCK结构体中。</p>
<p>MEMORY_SLOT结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Memory slot.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_SLOT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_SLOT</span> *<span class="title">pNext</span>;</span></span><br><span class="line">        UINT8 buffer[MEMORY_SLOT_SIZE];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; MEMORY_SLOT, *PMEMORY_SLOT;</span><br></pre></td></tr></table></figure>
<p>MEMORY_BLOCK结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Memory block info. Placed at the head of each block.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BLOCK</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BLOCK</span> *<span class="title">pNext</span>;</span></span><br><span class="line">    PMEMORY_SLOT pFree;         <span class="comment">// First element of the free slot list.</span></span><br><span class="line">    UINT usedCount;</span><br><span class="line">&#125; MEMORY_BLOCK, *PMEMORY_BLOCK;</span><br></pre></td></tr></table></figure>
<p>返回一个未使用的MEMORY_SLOT</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID <span class="title">AllocateBuffer</span><span class="params">(LPVOID pOrigin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PMEMORY_SLOT  pSlot;</span><br><span class="line">    PMEMORY_BLOCK pBlock = GetMemoryBlock(pOrigin);</span><br><span class="line">    <span class="keyword">if</span> (pBlock == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从MEMORY_BLOCK中移除一个MEMORY_SLOT，usedCount加1</span></span><br><span class="line">    <span class="comment">// Remove an unused slot from the list.</span></span><br><span class="line">    pSlot = pBlock-&gt;pFree;</span><br><span class="line">    pBlock-&gt;pFree = pSlot-&gt;pNext;</span><br><span class="line">    pBlock-&gt;usedCount++;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line">    <span class="comment">// Fill the slot with INT3 for debugging.</span></span><br><span class="line">    <span class="built_in">memset</span>(pSlot, <span class="number">0xCC</span>, <span class="keyword">sizeof</span>(MEMORY_SLOT));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 返回一个未使用过的MEMROY_SLOT</span></span><br><span class="line">    <span class="keyword">return</span> pSlot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GetMemoryBlock"><a href="#GetMemoryBlock" class="headerlink" title="GetMemoryBlock"></a>GetMemoryBlock</h4><p>获取还未使用的MEMORY_SLOT所属的MEMORY_BLOCK</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PMEMORY_BLOCK <span class="title">GetMemoryBlock</span><span class="params">(LPVOID pOrigin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PMEMORY_BLOCK pBlock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">  <span class="comment">// 64位代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Look the registered blocks for a reachable one.</span></span><br><span class="line">    <span class="keyword">for</span> (pBlock = g_pMemoryBlocks; pBlock != <span class="literal">NULL</span>; pBlock = pBlock-&gt;pNext)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">	<span class="comment">// 64位代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// The block has at least one unused slot.</span></span><br><span class="line">        <span class="comment">// 返回存在MEMORY_SLOT的MEMORY_BLOCK</span></span><br><span class="line">        <span class="keyword">if</span> (pBlock-&gt;pFree != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> pBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">	<span class="comment">// 64位代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// In x86 mode, a memory block can be placed anywhere.</span></span><br><span class="line">    pBlock = (PMEMORY_BLOCK)VirtualAlloc(</span><br><span class="line">        <span class="literal">NULL</span>, MEMORY_BLOCK_SIZE, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 分配一块MEMORY_BLOCK，在MEMORY_BLOCK中创建单向链表</span></span><br><span class="line">    <span class="comment">// 初始化单向链表，每次从末尾插入一个slot，在一块连续内存MEMORY_BLOCK中构建起了以MEMORY_SLOT为单位的链表</span></span><br><span class="line">    <span class="comment">// 第一个MEMORY_SLOT指向为空</span></span><br><span class="line">    <span class="keyword">if</span> (pBlock != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Build a linked list of all the slots.</span></span><br><span class="line">        PMEMORY_SLOT pSlot = (PMEMORY_SLOT)pBlock + <span class="number">1</span>;</span><br><span class="line">        pBlock-&gt;pFree = <span class="literal">NULL</span>;</span><br><span class="line">        pBlock-&gt;usedCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            pSlot-&gt;pNext = pBlock-&gt;pFree;</span><br><span class="line">            pBlock-&gt;pFree = pSlot;</span><br><span class="line">            pSlot++;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((ULONG_PTR)pSlot - (ULONG_PTR)pBlock &lt;= MEMORY_BLOCK_SIZE - MEMORY_SLOT_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 全局变量g_pMemoryBlocks指向最后一个MEMORY_BLOCK，MEMORY_BLOCK构成一个单向链表</span></span><br><span class="line">        pBlock-&gt;pNext = g_pMemoryBlocks;</span><br><span class="line">        g_pMemoryBlocks = pBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回MEMORY_BLCOK</span></span><br><span class="line">    <span class="keyword">return</span> pBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CreateTrampolineFunction-反汇编hook处代码，建立trampoline"><a href="#CreateTrampolineFunction-反汇编hook处代码，建立trampoline" class="headerlink" title="CreateTrampolineFunction(反汇编hook处代码，建立trampoline)"></a>CreateTrampolineFunction(反汇编hook处代码，建立trampoline)</h4><p>由于代码过长，不再贴出具体的代码。其主要是调用hde32_disasm实现opcode的识别，同时构造调用原函数的trampoline，实现执行原hook处被影响的指令，同时跳转到hook后执行代码。</p>
<p>TRAMPOLINE结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TRAMPOLINE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LPVOID pTarget;         <span class="comment">// [In] Address of the target function.</span></span><br><span class="line">    LPVOID pDetour;         <span class="comment">// [In] Address of the detour function.</span></span><br><span class="line">    LPVOID pTrampoline;     <span class="comment">// [In] Buffer address for the trampoline and relay function.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">    LPVOID pRelay;          <span class="comment">// [Out] Address of the relay function.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    BOOL   patchAbove;      <span class="comment">// [Out] Should use the hot patch area?</span></span><br><span class="line">    UINT   nIP;             <span class="comment">// [Out] Number of the instruction boundaries.</span></span><br><span class="line">    UINT8  oldIPs[<span class="number">8</span>];       <span class="comment">// [Out] Instruction boundaries of the target function.</span></span><br><span class="line">    UINT8  newIPs[<span class="number">8</span>];       <span class="comment">// [Out] Instruction boundaries of the trampoline function.</span></span><br><span class="line">&#125; TRAMPOLINE, *PTRAMPOLINE;</span><br></pre></td></tr></table></figure>
<h4 id="hde32-disasm"><a href="#hde32-disasm" class="headerlink" title="hde32_disasm"></a>hde32_disasm</h4><p>hde32反汇编库，hde32_disasm内部实现反汇编代码，能够解析汇编</p>
<h4 id="AddHookEntry"><a href="#AddHookEntry" class="headerlink" title="AddHookEntry"></a>AddHookEntry</h4><p>HOOK_ENTRY结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">HOOK_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LPVOID pTarget;             <span class="comment">// Address of the target function.</span></span><br><span class="line">    LPVOID pDetour;             <span class="comment">// Address of the detour or relay function.</span></span><br><span class="line">    LPVOID pTrampoline;         <span class="comment">// Address of the trampoline function.</span></span><br><span class="line">    UINT8  backup[<span class="number">8</span>];           <span class="comment">// Original prologue of the target function.</span></span><br><span class="line"></span><br><span class="line">    UINT8  patchAbove  : <span class="number">1</span>;     <span class="comment">// Uses the hot patch area.</span></span><br><span class="line">    UINT8  isEnabled   : <span class="number">1</span>;     <span class="comment">// Enabled.</span></span><br><span class="line">    UINT8  queueEnable : <span class="number">1</span>;     <span class="comment">// Queued for enabling/disabling when != isEnabled.</span></span><br><span class="line"></span><br><span class="line">    UINT   nIP : <span class="number">4</span>;             <span class="comment">// Count of the instruction boundaries.</span></span><br><span class="line">    UINT8  oldIPs[<span class="number">8</span>];           <span class="comment">// Instruction boundaries of the target function.</span></span><br><span class="line">    UINT8  newIPs[<span class="number">8</span>];           <span class="comment">// Instruction boundaries of the trampoline function.</span></span><br><span class="line">&#125; HOOK_ENTRY, *PHOOK_ENTRY;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PHOOK_ENTRY <span class="title">AddHookEntry</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_hooks.pItems == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 初始化,创建HookEntry数组</span></span><br><span class="line">        g_hooks.capacity = INITIAL_HOOK_CAPACITY;</span><br><span class="line">        g_hooks.pItems = (PHOOK_ENTRY)HeapAlloc(</span><br><span class="line">            g_hHeap, <span class="number">0</span>, g_hooks.capacity * <span class="keyword">sizeof</span>(HOOK_ENTRY));</span><br><span class="line">        <span class="keyword">if</span> (g_hooks.pItems == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (g_hooks.size &gt;= g_hooks.capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        PHOOK_ENTRY p = (PHOOK_ENTRY)HeapReAlloc(</span><br><span class="line">            g_hHeap, <span class="number">0</span>, g_hooks.pItems, (g_hooks.capacity * <span class="number">2</span>) * <span class="keyword">sizeof</span>(HOOK_ENTRY));</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        g_hooks.capacity *= <span class="number">2</span>;</span><br><span class="line">        g_hooks.pItems = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回一个HOOK_ENTRY</span></span><br><span class="line">    <span class="keyword">return</span> &amp;g_hooks.pItems[g_hooks.size++];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后保存hook的所有条件到HOOK_ENTRY当中，同时备份原代码，为hook最准备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (pHook != <span class="literal">NULL</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            pHook-&gt;pTarget     = ct.pTarget;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_M_X64) || defined(__x86_64__)</span></span><br><span class="line">                            pHook-&gt;pDetour     = ct.pRelay;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                            pHook-&gt;pDetour     = ct.pDetour;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                            pHook-&gt;pTrampoline = ct.pTrampoline;</span><br><span class="line">                            pHook-&gt;patchAbove  = ct.patchAbove;</span><br><span class="line">                            pHook-&gt;isEnabled   = FALSE;</span><br><span class="line">                            pHook-&gt;queueEnable = FALSE;</span><br><span class="line">                            pHook-&gt;nIP         = ct.nIP;</span><br><span class="line">                            <span class="built_in">memcpy</span>(pHook-&gt;oldIPs, ct.oldIPs, ARRAYSIZE(ct.oldIPs));</span><br><span class="line">                            <span class="built_in">memcpy</span>(pHook-&gt;newIPs, ct.newIPs, ARRAYSIZE(ct.newIPs));</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// Back up the target function.</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ct.patchAbove)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">memcpy</span>(</span><br><span class="line">                                    pHook-&gt;backup,</span><br><span class="line">                                    (LPBYTE)pTarget - <span class="keyword">sizeof</span>(JMP_REL),</span><br><span class="line">                                    <span class="keyword">sizeof</span>(JMP_REL) + <span class="keyword">sizeof</span>(JMP_REL_SHORT));</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">memcpy</span>(pHook-&gt;backup, pTarget, <span class="keyword">sizeof</span>(JMP_REL));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ppOriginal != <span class="literal">NULL</span>)</span><br><span class="line">                                <span class="comment">// 设置trampoline</span></span><br><span class="line">                                *ppOriginal = pHook-&gt;pTrampoline;</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="MH-EnableHook"><a href="#MH-EnableHook" class="headerlink" title="MH_EnableHook"></a>MH_EnableHook</h3><p>调用EnableHook</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MH_STATUS WINAPI <span class="title">MH_EnableHook</span><span class="params">(LPVOID pTarget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> EnableHook(pTarget, TRUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EnableHook"><a href="#EnableHook" class="headerlink" title="EnableHook"></a>EnableHook</h4><p>EnableHook的内容就比较简单了，主要利用HOOK_ENTRY修改pTarget，其中需要重点关注的就是用来保证hook时多线程安全的Freeze函数了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> MH_STATUS <span class="title">EnableHook</span><span class="params">(LPVOID pTarget, BOOL enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MH_STATUS status = MH_OK;</span><br><span class="line"></span><br><span class="line">    EnterSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_hHeap != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pTarget == MH_ALL_HOOKS)</span><br><span class="line">        &#123;</span><br><span class="line">            status = EnableAllHooksLL(enable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            FROZEN_THREADS threads;</span><br><span class="line">            UINT pos = FindHookEntry(pTarget);</span><br><span class="line">            <span class="keyword">if</span> (pos != INVALID_HOOK_POS)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (g_hooks.pItems[pos].isEnabled != enable)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 保证线程安全</span></span><br><span class="line">                    Freeze(&amp;threads, pos, ACTION_ENABLE);</span><br><span class="line"></span><br><span class="line">                    status = EnableHookLL(pos, enable);</span><br><span class="line"></span><br><span class="line">                    Unfreeze(&amp;threads);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    status = enable ? MH_ERROR_ENABLED : MH_ERROR_DISABLED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                status = MH_ERROR_NOT_CREATED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        status = MH_ERROR_NOT_INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LeaveSpinLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Freeze-进行hook时的多线程安全性保证"><a href="#Freeze-进行hook时的多线程安全性保证" class="headerlink" title="Freeze(进行hook时的多线程安全性保证)"></a>Freeze(进行hook时的多线程安全性保证)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VOID <span class="title">Freeze</span><span class="params">(PFROZEN_THREADS pThreads, UINT pos, UINT action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pThreads-&gt;pItems   = <span class="literal">NULL</span>;</span><br><span class="line">    pThreads-&gt;capacity = <span class="number">0</span>;</span><br><span class="line">    pThreads-&gt;size     = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 枚举当前进程中除当前执行线程以外的所有线程</span></span><br><span class="line">    EnumerateThreads(pThreads);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pThreads-&gt;pItems != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        UINT i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pThreads-&gt;size; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            HANDLE hThread = OpenThread(THREAD_ACCESS, FALSE, pThreads-&gt;pItems[i]);</span><br><span class="line">            <span class="keyword">if</span> (hThread != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将线程挂起</span></span><br><span class="line">                SuspendThread(hThread);</span><br><span class="line">                <span class="comment">// 处理已经执行到hook位置的线程</span></span><br><span class="line">                ProcessThreadIPs(hThread, pos, action);</span><br><span class="line">                CloseHandle(hThread);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####EnumerateThreads</p>
<p>这个函数比较简单，就是找出在当前进程中，除了当前进程的当前执行线程以外的所有线程，保存在pThreads当中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VOID <span class="title">EnumerateThreads</span><span class="params">(PFROZEN_THREADS pThreads)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        THREADENTRY32 te;</span><br><span class="line">        te.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">        <span class="keyword">if</span> (Thread32First(hSnapshot, &amp;te))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (te.dwSize &gt;= (FIELD_OFFSET(THREADENTRY32, th32OwnerProcessID) + <span class="keyword">sizeof</span>(DWORD))</span><br><span class="line">                    &amp;&amp; te.th32OwnerProcessID == GetCurrentProcessId()</span><br><span class="line">                    &amp;&amp; te.th32ThreadID != GetCurrentThreadId())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (pThreads-&gt;pItems == <span class="literal">NULL</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        pThreads-&gt;capacity = INITIAL_THREAD_CAPACITY;</span><br><span class="line">                        pThreads-&gt;pItems</span><br><span class="line">                            = (LPDWORD)HeapAlloc(g_hHeap, <span class="number">0</span>, pThreads-&gt;capacity * <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line">                        <span class="keyword">if</span> (pThreads-&gt;pItems == <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (pThreads-&gt;size &gt;= pThreads-&gt;capacity)</span><br><span class="line">                    &#123;</span><br><span class="line">                        LPDWORD p = (LPDWORD)HeapReAlloc(</span><br><span class="line">                            g_hHeap, <span class="number">0</span>, pThreads-&gt;pItems, (pThreads-&gt;capacity * <span class="number">2</span>) * <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line">                        <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                        pThreads-&gt;capacity *= <span class="number">2</span>;</span><br><span class="line">                        pThreads-&gt;pItems = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pThreads-&gt;pItems[pThreads-&gt;size++] = te.th32ThreadID;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                te.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">            &#125; <span class="keyword">while</span> (Thread32Next(hSnapshot, &amp;te));</span><br><span class="line">        &#125;</span><br><span class="line">        CloseHandle(hSnapshot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后续就是挂起线程，以及处理已经执行到hook位置的线程，以保证hook时的多线程安全性。</p>
<p>以上就是Minhook库的32位源代码重要部分的简析。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/08/31/PE与ELF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/31/PE与ELF/" class="post-title-link" itemprop="url">PE与ELF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-31 11:30:22 / Modified: 11:42:49" itemprop="dateCreated datePublished" datetime="2020-08-31T11:30:22+08:00">2020-08-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>关于PE和ELF(特指可执行文件)的结构分布，网上有很多资料介绍，这里就不再重复描述，仅记录一些自己认为重要的点，现在记录的内容不是最终的内容，会在不断加深对二者结构的认识过程中不断更新。</p>
<p>下面的表格是个人用来进行比较的点(简记)：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th>PE</th>
<th>ELF(特指可执行文件)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">静态时文件结构</td>
<td>Dos头-&gt;DosStub-&gt;Nt头-&gt;节表头-&gt;文件对齐的节区；是一种顺序的结构</td>
<td>ELF头-&gt;Segment头(程序头表)-&gt;Segments(Sections)-&gt;节表头；Segment与Section重合，不是一种顺序的结构，程序头表与节表头均指向文件中心位置</td>
</tr>
<tr>
<td style="text-align:left">加载时文件结构</td>
<td>Dos头-&gt;DosStub-&gt;Nt头-&gt;节表头-&gt;内存对齐的节区</td>
<td>Loadable Segments</td>
</tr>
<tr>
<td style="text-align:left">导入表填充含义</td>
<td>.idata中的IAT字段填充；填充时机：加载时</td>
<td>.got.plt中的字段填充；填充时机：延迟加载</td>
</tr>
<tr>
<td style="text-align:left">重定位</td>
<td>PE加载时，使用绝对地址的全局变量或者跳转都需要实现一个减去原基地址，加上新基地址的操作。需要重定位的数据保存在.reloc段中</td>
<td>本质上是got表填充。ELF加载时，首先填充got表的数据；延迟加载的机制填充got.plt的函数字段。需要重定位的数据保存在.relc.dyn和relc.plt中</td>
</tr>
<tr>
<td style="text-align:left">获取导出函数地址</td>
<td>解析dll的PE文件，从导出表EAT中获取函数地址</td>
<td>利用so的dynsym与dynstr比较符号名称，从dynsym获取符号对应的函数相对偏移</td>
</tr>
</tbody>
</table>
<p>二者的重定位含义完全不同的原因：ELF中的全局变量等数据，用的是相对偏移而不是绝对偏移。PE使用的是绝对偏移。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/05/07/VMP-修复dump内存导入表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/07/VMP-修复dump内存导入表/" class="post-title-link" itemprop="url">VMP-修复dump内存导入表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-07 00:04:33 / Modified: 00:08:33" itemprop="dateCreated datePublished" datetime="2020-05-07T00:04:33+08:00">2020-05-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/reverse/" itemprop="url" rel="index"><span itemprop="name">reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="VMP-“完美”修复dump内存导入表"><a href="#VMP-“完美”修复dump内存导入表" class="headerlink" title="VMP-“完美”修复dump内存导入表"></a>VMP-“完美”修复dump内存导入表</h1><p>修复对应64位程序(ring3)，不能应用于32位，跳转指令含义不同。一些原理就不介绍了，主要说明一下修复dump内存导入表的步骤，使得可以直接使用IDA逆向，思路也是借鉴了前人，后附参考链接，先展示一下修复前后的效果吧。</p>
<p>下图是直接dump下来的内存，不过还是修改了SizeOfRawData和PointerToRawData的，并且进行过针对无壳程序dump内存IAT修复方式处理过。</p>
<p><img src="https://invicsfate.github.io/assert/VMP8.png" alt="VMP8"></p>
<p>下图是修复dump内存IAT过后的，放两张图。</p>
<p><img src="https://invicsfate.github.io/assert/VMP9.png" alt="VMP9"></p>
<p><img src="https://invicsfate.github.io/assert/VMP10.png" alt="VMP10"></p>
<p>上图程序还没加载完，看着很舒服，完美。</p>
<p>实现修复VMP dump内存导入表的关键步骤如下，分小标题介绍。</p>
<h2 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h2><p>文件加载到IDA上，成功地反汇编呈现给我们，事实上是实现了内存自加载PE(可以这样理解，但其实不是)，所以修复的关键是要让其成功模拟内存自加载，内存自加载有以下三个要点：</p>
<ul>
<li>内存对齐，即文件映射到内存，文件每个节区实现从memcpy(VirtualAddrss，PointerToRawData，SizeOfRawData)</li>
<li>修复导入表</li>
<li>重定位</li>
</ul>
<p>因此，对应要点进行修复。</p>
<h3 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h3><p>由于dump下来的文件已经是内存状态，如果要让IDA识别，需要修改两个字段，每个节表头的PointerToRawData以及SizeOfRawData，满足PointerToRawData == VirtualAddress，SizeOfRawData == VirtualSize。</p>
<p>PointerToRawData == VirtualAddress</p>
<p><img src="https://invicsfate.github.io/assert/VMP1.png" alt="VMP1"></p>
<p>izeOfRawData == VirtualSize</p>
<p><img src="https://invicsfate.github.io/assert/VMP2.png" alt="VMP2"></p>
<p>此时，把dump下来的文件放到IDA已经可以加载，但是导入表是坏的。</p>
<p>备注：需要注意的是，dump下来的内存中原始的Import Table指向的VirtualAddress和Size都不是进程真正使用的导入表位置，真正的导入表位置已经被VMP修改到其他位置，但是原始的Import Table可以帮助我们修复导入表。</p>
<h3 id="重定位"><a href="#重定位" class="headerlink" title="重定位"></a>重定位</h3><p>并不需要重定位，不需要修改Image Base，保持不动。</p>
<h3 id="修复导入表"><a href="#修复导入表" class="headerlink" title="修复导入表"></a>修复导入表</h3><p>下面是重头戏，修复导入表，核心的编程点如下：</p>
<ul>
<li>添加一个新的区段，用于存放我们新建的导入表以及其相关结构</li>
</ul>
<p><img src="https://invicsfate.github.io/assert/VMP3.png" alt="VMP3"></p>
<p>​    我的程序导入的函数很多，所用空间比较大，申请了0x15000大小的区段</p>
<ul>
<li><p>扫描内存dump文件中特定的opcode，64位程序对应ff 15/25</p>
<p><img src="https://invicsfate.github.io/assert/VMP4.png" alt="VMP4"></p>
</li>
<li><p>找到ff 15/25的位置，记下该位置，之后要修改ff 15/25 后面的四个字节，修改其IAT位置到我们新建的IAT当中</p>
<p><img src="https://invicsfate.github.io/assert/VMP5.png" alt="VMP5"></p>
</li>
<li><p>通过找到ff 15/25位置，找到dump内存中动态加载该API函数的地址，保存地址</p>
<p><img src="https://invicsfate.github.io/assert/VMP6.png" alt="VMP6"></p>
</li>
<li><p>利用原始Import Table找到进程载入的所有的DLL名称，如果Import Table指向的位置没有，那么搜索dll字符串，定位所有的dll名称，把它整合一下。LoadLibrary所有dll，从EAT中遍历该DLL的所有地址与找到的API函数地址匹配</p>
</li>
<li><p>匹配成功，保存函数名以及对应的ff 15/25位置，下标一一对应，并记录匹配的函数个数，方便IAT内存的合理分配</p>
<p><img src="https://invicsfate.github.io/assert/VMP7.png" alt="VMP7"></p>
</li>
<li><p>重建IAT，我是0x20字节用于存放0x14大小的ImportDescriptor，0x30开始对应Name字段，接着是OriginalFirstThunk以及FirstThunk，最后是一个个的IMAGE_IMPORT_BY_NAME结构 </p>
</li>
<li><p>同时修改ff 15/25对应的后4字节，让其指向我们新建的IAT位置，一一对应</p>
</li>
</ul>
<p>另外，dump以后的内存，要保证在不重启的情况下，使用工具修复，重启会使得系统DLL地址重新分配。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://bbs.pediy.com/thread-248812.htm" target="_blank" rel="noopener">手动分析VMP加密的x64驱动导入表</a></p>
<p><a href="https://bbs.pediy.com/thread-249322.htm" target="_blank" rel="noopener">使用模拟器进行x64驱动的Safengine脱壳+导入表修复</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/04/24/VS2019-汇编asm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/24/VS2019-汇编asm/" class="post-title-link" itemprop="url">VS编译汇编/VS内核开发环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-24 10:30:22" itemprop="dateCreated datePublished" datetime="2020-04-24T10:30:22+08:00">2020-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-31 11:51:21" itemprop="dateModified" datetime="2020-08-31T11:51:21+08:00">2020-08-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="驱动开发环境搭建"><a href="#驱动开发环境搭建" class="headerlink" title="驱动开发环境搭建"></a>驱动开发环境搭建</h2><p>​    参考msdn官方文档，注意VS版本(Windows版本是否会影响不清楚，没试过)和SDK，WDK匹配的问题，SDK，WDK版本号一致，但是不匹配对应的VS版本都不行。</p>
<table>
<thead>
<tr>
<th>VS版本</th>
<th>Versions of Windows</th>
<th>SDK版本</th>
<th>WDK版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>VS2019-Community</td>
<td>Windows 10,version 1903</td>
<td>10.0.18362.0</td>
<td>10.0.18362.1</td>
</tr>
<tr>
<td>VS2019-Community</td>
<td>Windows 10,version 2004</td>
<td>10.0.19041.0</td>
<td>10.0.19041.1</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>​    配置好后，还需要安装spectre缓解的单个组件，在VS修复里面找到单个组件项，搜索spectre安装(MSVC开头的)。将警告视为错误关闭，然后就可以愉快的开发了。</p>
<h2 id="VS2019-汇编asm"><a href="#VS2019-汇编asm" class="headerlink" title="VS2019+汇编asm"></a>VS2019+汇编asm</h2><p>编写单独的asm文件，而不是使用内嵌汇编的方式，记录一下编写方法：</p>
<ul>
<li>新建cpp文件，修改文件后缀为asm</li>
<li>工程右键-&gt;生成依赖项-&gt;生成自定义，勾选masm，点确定</li>
<li>右键asm文件-&gt;属性-&gt;常规，项内容修改为Microsoft Macro Assembler</li>
</ul>
<p>此时asm文件便可编译了，asm文件中函数的声明可以放到头文件中。</p>
<p>asm编译生成的函数一般是按照C语言的规范去解析的，这一点需要注意。如果在链接时出现找不到定义，一般就是这种情况，同一个项目中存在按cpp解析生成的obj，以及按C解析生成的obj，二者在寻找函数名或者对象名这些时，会受C/C++各自编译的规则去寻找对象，当不一致时，就会产生找不到定义的情况。此时的解决方法根据项目内容一般有两种：</p>
<ol>
<li>此时一般使用extern “C”将cpp类型按照C语言规则解析</li>
<li>或者将c文件后缀改成cpp即可解决。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/04/20/windows原始套接字sock-raw的使用限制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/20/windows原始套接字sock-raw的使用限制/" class="post-title-link" itemprop="url">windows原始套接字sock_raw的使用限制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-20 12:00:00 / Modified: 12:05:14" itemprop="dateCreated datePublished" datetime="2020-04-20T12:00:00+08:00">2020-04-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="windows原始套接字sock-raw的使用限制"><a href="#windows原始套接字sock-raw的使用限制" class="headerlink" title="windows原始套接字sock_raw的使用限制"></a>windows原始套接字sock_raw的使用限制</h2><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>windows版本：Windows10 1903</p>
<h3 id="限制总结"><a href="#限制总结" class="headerlink" title="限制总结"></a>限制总结</h3><p>​    分析ddos泛洪攻击的文章很多，本文记录下windows下原始套接字sock_raw的使用限制。<br>    原始套接字能够让开发者自行解析和构造网络层和数据传输层的IP头，UDP头和TCP头等数据。笔者将能够在linux下测试成功的UDP Flood(使用原始套接字sock_raw的)代码移植到windows下进行测试，失败，经过多次抓包对比IP头，UDP头，在MSDN上找到了答案，总结一下windows下的限制：</p>
<ul>
<li><p>windows下使用原始套接字sock_raw的程序需要以管理权权限启动</p>
</li>
<li><p>TCP数据无法通过原始套接字发送</p>
</li>
<li><p>源地址无效的UDP数据报不能通过原始套接字发送(微软为了限制恶意代码创建分布式拒绝服务攻击以及伪造源IP地址的TCP/IP数据包)</p>
<p>附MSDN图：</p>
</li>
</ul>
<p><img src="https://invicsfate.github.io/assert/socket_raw1.png" alt="socket_raw1"></p>
<p>​    通过原始套接字发送的数据包，windows会检查你的源IP是否为本机IP(合法IP)，如果不是，那么发送不出去；修改源IP为本机才能正常发送，但是这样发送出去的数据包还不如直接发以<strong>SOCK_STREAM</strong>和<strong>SOCK_DGRAM</strong>类型的套接字建立的数据包。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket" target="_blank" rel="noopener">TCP/IP Raw Sockets</a></p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2020/02/15/nginx-https-CGI-post数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/15/nginx-https-CGI-post数据/" class="post-title-link" itemprop="url">nginx-https-CGI-post数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-02-15 16:21:55 / Modified: 17:54:49" itemprop="dateCreated datePublished" datetime="2020-02-15T16:21:55+08:00">2020-02-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="nginx-https-CGI-post数据"><a href="#nginx-https-CGI-post数据" class="headerlink" title="nginx-https-CGI-post数据"></a>nginx-https-CGI-post数据</h2><p>一个C语言编写的CGI脚本测试demo。</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="中间件-nginx"><a href="#中间件-nginx" class="headerlink" title="中间件-nginx"></a>中间件-nginx</h4><p>从<a href="http://nginx.org/download/" target="_blank" rel="noopener">nginx-download</a>下载最新版本的nginx。安装openssl，也可以使用源代码进行安装，示例安装即为使用openssl源代码，–add-module添加其他模块，如–add-module=path/to/nginx_upload_module。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --with-http_stub_status_module --with-http_ssl_module --with-openssl=path/to/openssl <span class="comment">#https配置</span></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>访问本地80端口能看到nginx的欢迎界面。</p>
<h4 id="本地https搭建"><a href="#本地https搭建" class="headerlink" title="本地https搭建"></a>本地https搭建</h4><p>使用openssl生成共私钥，CA证书，客户端服务器证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成服务端私钥</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"><span class="comment"># 生成服务端公钥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> server.key -pubout -out server.pem</span><br><span class="line"><span class="comment"># 生成客户端私钥</span></span><br><span class="line">openssl genrsa -out client.key 2048</span><br><span class="line"><span class="comment"># 生成客户端公钥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> client.key -pubout -out client.pem</span><br><span class="line"><span class="comment"># 生成CA证书</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -new -key ca.key -out ca.csr</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ca.csr -signkey ca.key -out  ca.crt</span><br><span class="line"><span class="comment"># 生成客户端服务端证书</span></span><br><span class="line"><span class="comment"># 服务端证书，向CA申请签名</span></span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line">openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> server.csr -out server.crt</span><br><span class="line"><span class="comment"># 客户端证书，向CA申请签名</span></span><br><span class="line">openssl req -new -key client.key -out client.csr</span><br><span class="line">openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> client.csr -out client.crt</span><br></pre></td></tr></table></figure>
<p>生成完毕，在nginx安装目录下新建一个ssl目录，用于存放服务器证书和密钥，配置nginx.conf。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HTTPS server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate      ../ssl/server.crt;<span class="comment">#服务器证书</span></span><br><span class="line">    ssl_certificate_key  ../ssl/server.key;<span class="comment">#服务器私钥</span></span><br><span class="line"></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># CGI configure</span></span><br><span class="line">    location ~ \.cgi$ &#123;</span><br><span class="line">        root           /usr/<span class="built_in">local</span>/nginx/cgi-bin;</span><br><span class="line">        fastcgi_pass   unix:/var/run/fcgiwrap.socket;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx，访问https//localhost:443/确定是否配置成功。</p>
<h4 id="fcgiwrap运行CGI脚本"><a href="#fcgiwrap运行CGI脚本" class="headerlink" title="fcgiwrap运行CGI脚本"></a>fcgiwrap运行CGI脚本</h4><p>安装fcgiwrap用以启动C语言，php，bash等编写的应用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libfcgi-dev</span><br><span class="line">sudo apt-get install spawn-fcgi</span><br><span class="line">sudo apt-get install fcgiwrap</span><br></pre></td></tr></table></figure>
<p>服务会立即启动，查看服务状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl status fcgiwrap.service</span><br><span class="line">systemctl status fcgiwrap.socket</span><br></pre></td></tr></table></figure>
<p>在nginx安装根目录下新建cgi-bin目录，编写一个测试demo，demo功能识别GET或POST方法，对POST方法的部分数据进行读，并写在本地服务器下，实现简单的数据上传。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcgi_stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include&lt;fcgi_config.h&gt;</span></span><br><span class="line"><span class="comment">//#include&lt;fcgiapp.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(<span class="keyword">char</span> *pQueryStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *pName = <span class="literal">NULL</span>;</span><br><span class="line">	pName = <span class="built_in">strstr</span>(pQueryStr,<span class="string">"name"</span>);</span><br><span class="line">	<span class="keyword">if</span>(pName)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> *pTmp = pName + <span class="number">5</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Hello %s!\r\n"</span>,pTmp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"No Name!\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveToFile</span><span class="params">(<span class="keyword">char</span> *pContent,<span class="keyword">int</span> contentLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	fp = fopen(<span class="string">"fateStealData"</span>,<span class="string">"ab+"</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Preparing to write sth!\r\n"</span>);</span><br><span class="line">		fwrite(pContent,<span class="keyword">sizeof</span>(<span class="keyword">char</span>),contentLength,fp);</span><br><span class="line">		fclose(fp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Opening file error!\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(FCGI_Accept() &gt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> *pMethod = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">char</span> *pQueryStr = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">char</span> *pContentType = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">char</span> *pPostContent = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="comment">//http header</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Content-Type: text/plain\r\n\r\n"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//content</span></span><br><span class="line">		pMethod = getenv(<span class="string">"REQUEST_METHOD"</span>);</span><br><span class="line">		<span class="keyword">if</span>(pMethod &amp;&amp; !<span class="built_in">strcmp</span>(pMethod,<span class="string">"GET"</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			pQueryStr = getenv(<span class="string">"QUERY_STRING"</span>);</span><br><span class="line">			<span class="keyword">if</span>(pQueryStr)</span><br><span class="line">			&#123;</span><br><span class="line">				sayHello(pQueryStr);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(pMethod &amp;&amp; !<span class="built_in">strcmp</span>(pMethod,<span class="string">"POST"</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			pContentType = getenv(<span class="string">"CONTENT_TYPE"</span>);</span><br><span class="line">			<span class="keyword">if</span>(pContentType)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(pContentType,<span class="string">"application/x-www-form-urlencoded"</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">int</span> contentLength = atoi(getenv(<span class="string">"CONTENT_LENGTH"</span>));</span><br><span class="line">					pPostContent = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(contentLength + <span class="number">1</span>);</span><br><span class="line">					<span class="keyword">if</span>(pPostContent)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">memset</span>(pPostContent,<span class="number">0</span>,contentLength + <span class="number">1</span>);</span><br><span class="line">						fread(pPostContent,<span class="keyword">sizeof</span>(<span class="keyword">char</span>),contentLength,<span class="built_in">stdin</span>);</span><br><span class="line">						sayHello(pPostContent);</span><br><span class="line">						saveToFile(pPostContent,contentLength + <span class="number">1</span>);</span><br><span class="line">						<span class="built_in">free</span>(pPostContent);</span><br><span class="line">						pPostContent = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"CONTENT_TYPE not supported now!\r\n"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    编译。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc mycgi.c -o mycgi.cgi -lfcgi</span><br></pre></td></tr></table></figure>
<p>​    放置在cgi-bin目录下。</p>
<h4 id="demo测试"><a href="#demo测试" class="headerlink" title="demo测试"></a>demo测试</h4><p>​    demo测试，post一段数据到服务器上，由于需要写文件，需要cgi-bin目录拥有写权限。</p>
<p>​    配置nginx.conf，重启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.cgi$ &#123;</span><br><span class="line">    root           /usr/<span class="built_in">local</span>/nginx/cgi-bin;</span><br><span class="line">    fastcgi_pass   unix:/var/run/fcgiwrap.socket;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    使用postman进行测试。post数据到https//ip/mycgi.cgi。</p>
<p><img src="https://invicsfate.github.io/assert/nginx1.png" alt="nginx1"></p>
<p>​    查看cgi-bin目录下是否生成了相应文件，测试完毕。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://www.nginx.com/resources/wiki/modules/upload/" target="_blank" rel="noopener">Upload | NGINX</a><br><a href="https://www.xiebruce.top/727.html" target="_blank" rel="noopener">Nginx配置Web服务器详解</a><br><a href="https://blog.seosiwei.com/detail/28" target="_blank" rel="noopener">已安装nginx支持https配置</a><br><a href="https://www.jianshu.com/p/57066821b863" target="_blank" rel="noopener">用Nginx搭建HTTPS服务器</a><br><a href="https://fastcgi-archives.github.io/FastCGI_Developers_Kit_FastCGI.html" target="_blank" rel="noopener">FastCGI Developer’s Kit</a><br><a href="http://chriswu.me/blog/writing-hello-world-in-fcgi-with-c-plus-plus/" target="_blank" rel="noopener">Writing Hello World in FCGI with C++</a><br><a href="https://blog.sleeplessbeastie.eu/2017/09/18/how-to-execute-cgi-scripts-using-fcgiwrap/" target="_blank" rel="noopener">How to execute CGI scripts using fcgiwrap</a><br><a href="https://tkstorm.com/posts-list/programming/spawn-fcgi/" target="_blank" rel="noopener">Spawns FastCGI Processes</a></p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2019/12/14/“绝对安全”的本地序列号验证方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/14/“绝对安全”的本地序列号验证方法/" class="post-title-link" itemprop="url">“绝对安全”的本地序列号验证方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-12-14 17:37:38 / Modified: 17:44:16" itemprop="dateCreated datePublished" datetime="2019-12-14T17:37:38+08:00">2019-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一种“绝对安全”的序列号验证方法"><a href="#一种“绝对安全”的序列号验证方法" class="headerlink" title="一种“绝对安全”的序列号验证方法"></a>一种“绝对安全”的序列号验证方法</h2><p>声明：</p>
<p>​    所谓的“绝对安全”:只是在自己目前的知识范围内认为其“绝对安全”(其实也不是QAQ)，天下逆向破解大神何其之多，这种验证方法也只是分享出来，供大家学习交流。</p>
<p>从逆向系统序列号学到的一种“绝对安全”的本地序列号验证方法，不需要联网验证只需要本地，即可实现攻击者“无法破解”，使得序列号只能由开发者提供。下面介绍一下这种序列号验证的代码思想，有以下四个步骤(顺序不固定)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>使用单向hash算法作为验证的核心，比如sha512：</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(sha512(checkBytes) == 硬编码的哈希值):</span><br><span class="line">	subKey = checkBytes</span><br><span class="line"></span><br><span class="line">其中checkBytes应为大于等于<span class="number">8</span>字节的字节串，每个字节取值范围<span class="number">0</span><span class="number">-255</span>，一般由其他算法得到。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>获取一些固定信息(如本计算机MAC地址)或者其他用户的输入(比如UserName),使用算法变换得到一组数据tmpData。</span><br><span class="line">举例：</span><br><span class="line">取sha512(The MAC Address of Computer)结果的<span class="number">16</span>/<span class="number">32</span>/etc字节作为流密码的密钥，流密码的输入可以固定，得到一组输出streamCipher</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>输入序列号变换算法随意，假定变换后得到的输出为serialNumber,checkBytes的来源如下：</span><br><span class="line"></span><br><span class="line">checkBytes = serialNumber ^ streamCipher</span><br><span class="line"></span><br><span class="line">将serialNumber和streamCipher进行变换得到checkBytes，例子中使用一个简单的异或算法，也没有任何问题。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>经过上面三个步骤的，攻击者可能可以强制跳转绕过哈希算法的校验，下面最最最关键的核心部分来了，在哈希校验通过以后，checkBytes赋值给了subKey，在程序的某处运用subKey进行如下操作：</span><br><span class="line"></span><br><span class="line">decryptFinalKey = sha512(subKey + <span class="string">"00 00 00 01"</span>)</span><br><span class="line"></span><br><span class="line">decryptFinalKey可以根据自己的喜好，取decryptFinalKey中的<span class="number">16</span>/<span class="number">32</span>/<span class="number">48</span>/<span class="number">64</span>字节，解密校验的<span class="string">"最终的数据"</span>，<span class="string">"最终的数据"</span>可以是安装系统中最后加载的文件系统，也可以是软件序列号最终的校验代码，也可以是软件进行安装的安装代码等等。试想一下，如果攻击者强制通过哈希算法校验，那么其在这一步必然无法正确解密<span class="string">"最终的数据"</span>，前面逆向分析的成果都将无用，化作泡影。</span><br></pre></td></tr></table></figure>
<p>以上四个步骤按照开发顺序一般是先2，3(3，2)，后1，4。每个步骤使用的算法自定，只要校验的核心思想没有产生变化，大概都是”无法破解”的吧，且确实符合一个UserName对应一个序列号这种序列号验证的基本思想。</p>
<p>但是存在的问题还是有的，即如果攻击者买了一个序列号，那么不管序列号经过如何复杂的混淆，变换，加解密，解编码得到serialNumber，攻击者都可以通过调试得到serialNumber，而streamCipher的变换输入来源攻击者也是知道的(比如UserName)，那么攻击者即可通过调试获得checkBytes的正确值，程序自然也就破解了。</p>
<p>解决办法：</p>
<p>1.不断加强校验步骤中的混淆算法，逆向过程会让人十分头疼，将劝退一部分逆向人员。</p>
<p>2.不断加强保护技术，包括但不限于虚拟机技术，反调试技术，混淆代码技术，新的壳算法等待，或者这些方法的混合使用，将劝退大部分逆向人员。</p>
<p>但就算是这样，每年最新的游戏不还是照样被国外大神们破解了么(吐槽)。。。攻防之间，攻击者与防御者相互促进相互学习，可能这就是安全的独特魅力吧！</p>
<p>​</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2019/12/07/C++逆向随笔/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/C++逆向随笔/" class="post-title-link" itemprop="url">C++逆向随笔</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-12-07 22:54:40 / Modified: 22:59:49" itemprop="dateCreated datePublished" datetime="2019-12-07T22:54:40+08:00">2019-12-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="C-逆向随笔"><a href="#C-逆向随笔" class="headerlink" title="C++逆向随笔"></a>C++逆向随笔</h1><p>看到什么想到什么，就记录什么。</p>
<h2 id="C-构造函数初始化对象"><a href="#C-构造函数初始化对象" class="headerlink" title="C++构造函数初始化对象"></a>C++构造函数初始化对象</h2><p>C++最具代表性的逆向点自然少不了类创建对象，类创建对象会自动调用其自身的构造函数，完成对象初始化，包括初始化赋值虚函数表，成员赋值等，用以下示例代码为例，示例代码摘自DirectX12龙书第四章Direct3D初始化。</p>
<h3 id="分析的源代码"><a href="#分析的源代码" class="headerlink" title="分析的源代码"></a>分析的源代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//D3DApp 类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D3DApp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">    D3DApp(HINSTANCE hInstance);</span><br><span class="line">    D3DApp(<span class="keyword">const</span> D3DApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">    D3DApp&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> D3DApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~D3DApp();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> D3DApp* <span class="title">GetApp</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">	<span class="function">HINSTANCE <span class="title">AppInst</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">HWND      <span class="title">MainWnd</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">float</span>     <span class="title">AspectRatio</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Get4xMsaaState</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Set4xMsaaState</span><span class="params">(<span class="keyword">bool</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span></span>; </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convenience overrides for handling mouse input.</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span>  </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitMainWindow</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitDirect3D</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateCommandObjects</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateSwapChain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FlushCommandQueue</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">ID3D12Resource* <span class="title">CurrentBackBuffer</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CalculateFrameStats</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LogAdapters</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LogAdapterOutputs</span><span class="params">(IDXGIAdapter* adapter)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LogOutputDisplayModes</span><span class="params">(IDXGIOutput* output, DXGI_FORMAT format)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> D3DApp* mApp;</span><br><span class="line"></span><br><span class="line">    HINSTANCE mhAppInst = <span class="literal">nullptr</span>; <span class="comment">// application instance handle</span></span><br><span class="line">    HWND      mhMainWnd = <span class="literal">nullptr</span>; <span class="comment">// main window handle</span></span><br><span class="line">	<span class="keyword">bool</span>      mAppPaused = <span class="literal">false</span>;  <span class="comment">// is the application paused?</span></span><br><span class="line">	<span class="keyword">bool</span>      mMinimized = <span class="literal">false</span>;  <span class="comment">// is the application minimized?</span></span><br><span class="line">	<span class="keyword">bool</span>      mMaximized = <span class="literal">false</span>;  <span class="comment">// is the application maximized?</span></span><br><span class="line">	<span class="keyword">bool</span>      mResizing = <span class="literal">false</span>;   <span class="comment">// are the resize bars being dragged?</span></span><br><span class="line">    <span class="keyword">bool</span>      mFullscreenState = <span class="literal">false</span>;<span class="comment">// fullscreen enabled</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set true to use 4X MSAA (?.1.8).  The default is false.</span></span><br><span class="line">    <span class="keyword">bool</span>      m4xMsaaState = <span class="literal">false</span>;    <span class="comment">// 4X MSAA enabled</span></span><br><span class="line">    UINT      m4xMsaaQuality = <span class="number">0</span>;      <span class="comment">// quality level of 4X MSAA</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Used to keep track of the 揹elta-time?and game time (?.4).</span></span><br><span class="line">	GameTimer mTimer;</span><br><span class="line">	</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;IDXGIFactory4&gt; mdxgiFactory;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;IDXGISwapChain&gt; mSwapChain;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12Device&gt; md3dDevice;</span><br><span class="line"></span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12Fence&gt; mFence;</span><br><span class="line">    UINT64 mCurrentFence = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> SwapChainBufferCount = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> mCurrBackBuffer = <span class="number">0</span>;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mSwapChainBuffer[SwapChainBufferCount];</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mDepthStencilBuffer;</span><br><span class="line"></span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mRtvHeap;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mDsvHeap;</span><br><span class="line"></span><br><span class="line">    D3D12_VIEWPORT mScreenViewport; </span><br><span class="line">    D3D12_RECT mScissorRect;</span><br><span class="line"></span><br><span class="line">	UINT mRtvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mDsvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mCbvSrvUavDescriptorSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Derived class should set these in derived constructor to customize starting values.</span></span><br><span class="line">	<span class="built_in">std</span>::wstring mMainWndCaption = <span class="string">L"d3d App"</span>;</span><br><span class="line">	D3D_DRIVER_TYPE md3dDriverType = D3D_DRIVER_TYPE_HARDWARE;</span><br><span class="line">    DXGI_FORMAT mBackBufferFormat = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">    DXGI_FORMAT mDepthStencilFormat = DXGI_FORMAT_D24_UNORM_S8_UINT;</span><br><span class="line">	<span class="keyword">int</span> mClientWidth = <span class="number">800</span>;</span><br><span class="line">	<span class="keyword">int</span> mClientHeight = <span class="number">600</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//InitDirect3DApp类 继承自D3DApp类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitDirect3DApp</span> :</span> <span class="keyword">public</span> D3DApp</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	InitDirect3DApp(HINSTANCE hInstance);</span><br><span class="line">	~InitDirect3DApp();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span>override</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span>override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span>override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span>override</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>InitDirect3DApp类创建theApp对象源代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE prevInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">				   PSTR cmdLine, <span class="keyword">int</span> showCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Enable run-time memory check for debug builds.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG) | defined(_DEBUG)</span></span><br><span class="line">	_CrtSetDbgFlag( _CRTDBG_ALLOC_MEM_DF | _CRTDBG_LEAK_CHECK_DF );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">InitDirect3DApp <span class="title">theApp</span><span class="params">(hInstance)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(!theApp.Initialize())</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> theApp.Run();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(DxException&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox(<span class="literal">nullptr</span>, e.ToString().c_str(), <span class="string">L"HR Failed"</span>, MB_OK);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分析的伪代码"><a href="#分析的伪代码" class="headerlink" title="分析的伪代码"></a>分析的伪代码</h3><p>InitDirect3DApp类创建theApp对象伪代码片段</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_1.png" alt="DX12Init_1"></p>
<p>InitDirect3DObject中是InitDirect3DApp类的构造函数，在其内部调用了其父类D3DApp的构造函数：</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_2.png" alt="DX12Init_2"></p>
<p>D3DAppObject即为D3DApp的构造函数，*v6=0ff_14004CD58是将子类InitDirect3DApp的虚函数表地址覆盖掉了D3DApp父类的虚函数表。</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_3.png" alt="DX12Init_3"></p>
<p>如上图，在D3DApp类的构造函数中<em>(QWORD </em>)v8 = off_140048148，赋予的是父类D3DApp的虚函数表地址。</p>
<p>父类D3DApp的虚函数表虚函数布局源代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">virtual</span> ~D3DApp();</span><br><span class="line">	......</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	......</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span></span>; </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convenience overrides for handling mouse input.</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span>  </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>父类D3DApp的虚函数表虚函数布局伪代码：</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_4.png" alt="DX12Init_4"></p>
<p>上图已经处理过命名，和源代码进行比对，布局和源代码完全一致。</p>
<p>子类InitDirect3DApp的虚函数表虚函数布局源代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	InitDirect3DApp(HINSTANCE hInstance);</span><br><span class="line">	~InitDirect3DApp();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span>override</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span>override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span>override</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span>override</span>;</span><br></pre></td></tr></table></figure>
<p>子类InitDirect3DApp的虚函数表虚函数布局伪代码：</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_5.png" alt="DX12Init_5"></p>
<p>子类中~InitDirect3DApp析构函数和父类~D3DApp析构函数不一致，函数地址不同。</p>
<p>子类中Initialize，OnResize，Update，Draw四个函数后有override标志，确保该函数为虚函数并覆写来自基类的虚函数，函数地址不同。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> InitDirect3DApp::Initialize()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!D3DApp::Initialize())</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> D3DApp::Initialize()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(!InitMainWindow())</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!InitDirect3D())</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the initial resize code.</span></span><br><span class="line">    OnResize();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>子类中InitDirect3DApp::Initialize()函数与D3DApp:Initialize()函数不同。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InitDirect3DApp::OnResize()</span><br><span class="line">&#123;</span><br><span class="line">	D3DApp::OnResize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OnResize函数，子类调用了父类的OnResize函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InitDirect3DApp::Update(<span class="keyword">const</span> GameTimer&amp; gt)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Update函数，子类中有定义，父类中无定义，仅有声明。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InitDirect3DApp::Draw(<span class="keyword">const</span> GameTimer&amp; gt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Reuse the memory associated with command recording.</span></span><br><span class="line">    <span class="comment">// We can only reset when the associated command lists have finished execution on the GPU.</span></span><br><span class="line">	ThrowIfFailed(mDirectCmdListAlloc-&gt;Reset());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// A command list can be reset after it has been added to the command queue via ExecuteCommandList.</span></span><br><span class="line">    <span class="comment">// Reusing the command list reuses memory.</span></span><br><span class="line">    ThrowIfFailed(mCommandList-&gt;Reset(mDirectCmdListAlloc.Get(), <span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Indicate a state transition on the resource usage.</span></span><br><span class="line">	mCommandList-&gt;ResourceBarrier(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::Transition(CurrentBackBuffer(),</span><br><span class="line">		D3D12_RESOURCE_STATE_PRESENT, D3D12_RESOURCE_STATE_RENDER_TARGET));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the viewport and scissor rect.  This needs to be reset whenever the command list is reset.</span></span><br><span class="line">    mCommandList-&gt;RSSetViewports(<span class="number">1</span>, &amp;mScreenViewport);</span><br><span class="line">    mCommandList-&gt;RSSetScissorRects(<span class="number">1</span>, &amp;mScissorRect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear the back buffer and depth buffer.</span></span><br><span class="line">	mCommandList-&gt;ClearRenderTargetView(CurrentBackBufferView(), Colors::LightSteelBlue, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	mCommandList-&gt;ClearDepthStencilView(DepthStencilView(), D3D12_CLEAR_FLAG_DEPTH | D3D12_CLEAR_FLAG_STENCIL, <span class="number">1.0f</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Specify the buffers we are going to render to.</span></span><br><span class="line">	mCommandList-&gt;OMSetRenderTargets(<span class="number">1</span>, &amp;CurrentBackBufferView(), <span class="literal">true</span>, &amp;DepthStencilView());</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Indicate a state transition on the resource usage.</span></span><br><span class="line">	mCommandList-&gt;ResourceBarrier(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::Transition(CurrentBackBuffer(),</span><br><span class="line">		D3D12_RESOURCE_STATE_RENDER_TARGET, D3D12_RESOURCE_STATE_PRESENT));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Done recording commands.</span></span><br><span class="line">	ThrowIfFailed(mCommandList-&gt;Close());</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Add the command list to the queue for execution.</span></span><br><span class="line">	ID3D12CommandList* cmdsLists[] = &#123; mCommandList.Get() &#125;;</span><br><span class="line">	mCommandQueue-&gt;ExecuteCommandLists(_countof(cmdsLists), cmdsLists);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// swap the back and front buffers</span></span><br><span class="line">	ThrowIfFailed(mSwapChain-&gt;Present(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">	mCurrBackBuffer = (mCurrBackBuffer + <span class="number">1</span>) % SwapChainBufferCount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait until frame commands are complete.  This waiting is inefficient and is</span></span><br><span class="line">	<span class="comment">// done for simplicity.  Later we will show how to organize our rendering code</span></span><br><span class="line">	<span class="comment">// so we do not have to wait per frame.</span></span><br><span class="line">	FlushCommandQueue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Draw函数，子类中有定义，父类中无定义。</p>
<p>MsgProc，CreateDesHeaps，OnMouseDown，OnMouseUp，OnMouseMove五个函数，子类没有重定义，函数地址相同。</p>
<p>————————————————————————-分界线————————————————————————-</p>
<p>上面是说虚函数，下面是紧接着对应的对象成员布局，伪代码成员布局与源代码布局一致(一开始贴了)，成员和成员之间遵循内存对齐的原则，下图直观(看不清的话，f12打开console，查看原图)：</p>
<p><img src="https://invicsfate.github.io/assert/DX12Init_6.png" alt="DX12Init_6"></p>
<p>以上就是编译好的程序中对象的内存布局，所有的公有函数，保护函数，私有函数都是直接调用的形式，不占用对象的内存空间。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2019/08/24/某游戏cg素材解包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/24/某游戏cg素材解包/" class="post-title-link" itemprop="url">某游戏cg素材解包</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-08-24 01:30:22 / Modified: 02:17:03" itemprop="dateCreated datePublished" datetime="2019-08-24T01:30:22+08:00">2019-08-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GameSecurity/" itemprop="url" rel="index"><span itemprop="name">GameSecurity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>解包某游戏素材，玩完觉得cg差几张，决定解开来看看是否少了cg。</p>
<h2 id="查看打包文件"><a href="#查看打包文件" class="headerlink" title="查看打包文件"></a>查看打包文件</h2><p>当前目录下的文件格式除了exe,dll以外就是类型为NPK的文件，NPK文件必为打包文件无疑，010 Editor查看文件格式，如下图(截取的开头部分)：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack1.png" alt="GameUnpack1"></p>
<p>根据文件头部上网搜索相关资料和工具(尝试过可能有用的arc_unpacker工具等)，无解。那就只能逆向解包啦！</p>
<p>推测负责解包的exe，并进行逆向分析，找到程序试图解包一个名为system.npk的文件。找到头部签名比对部分：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack2.png" alt="GameUnpack2"></p>
<p>接着往下分析程序，大致了解(猜测)了NPK文件的结构以及使用的加密算法AES256-cbc：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack3.png" alt="GameUnpack3"></p>
<p>图中黄色部分为签名，蓝色部分AES256的向量IV，绿色部分是加密的需要用到的该NPK文件中的所有文件的描述结构，大小为红色部分0xD460，绿色部分往下也就是0xD480往后就是加密的所有文件了。</p>
<p>通过AES256-cbc算法解密0xD460大小的文件描述结构，密钥硬编码在程序中，即可得到该NPK中加密的文件描述结构。解密出的一个文件描述结构如下图：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack4.png" alt="GameUnpack4"></p>
<p>如上图所示，黑色框起来的部分为一个png文件的解密描述结构，总共有0xD460大小的文件描述结构。程序中会根据计算机是否支持AES-NI指令集，而选择使用AES-NI指令集的方式进行解密，还是另外一种<br><a href="https://github.com/cisco/libsrtp/blob/master/crypto/cipher/aes.c" target="_blank" rel="noopener">github上的某AES</a>进行解密。<br>AES解密部分截图如下：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack5.png" alt="GameUnpack5"></p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack6.png" alt="GameUnpack6"></p>
<p>接下来，要做的就是解密文件了，一个png文件的解密描述结构中重要的就是蓝色部分，代表该png在npk文件中的起始地址，绿色部分代表该png文件的大小。在程序如何解密setting.ini文件的部分，如下图：</p>
<p><img src="https://invicsfate.github.io/assert/GameUnpack7.png" alt="GameUnpack7"></p>
<p>发现了是使用同样的解密算法AES256-cbc进行解密，并且IV和密钥相同。故写脚本提取出所有的png图片，一气呵成！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIV</span><span class="params">(content)</span>:</span></span><br><span class="line">	aes256IV = content[<span class="number">8</span>:<span class="number">24</span>]</span><br><span class="line">	<span class="keyword">return</span> aes256IV</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSecretKey</span><span class="params">(uiAesKey)</span>:</span></span><br><span class="line">	aesKey = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> ch <span class="keyword">in</span> uiAesKey:</span><br><span class="line">		ch = struct.pack(<span class="string">"&lt;I"</span>,ch)</span><br><span class="line">		aesKey += ch</span><br><span class="line">	<span class="keyword">return</span> aesKey</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(encrypted, passphrase)</span>:</span></span><br><span class="line">  IV = encrypted[:<span class="number">16</span>]</span><br><span class="line">  cipher = AES.new(passphrase,AES.MODE_CBC,IV)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> cipher.decrypt(encrypted[<span class="number">16</span>:])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(decrypted, passphrase)</span>:</span></span><br><span class="line"></span><br><span class="line">  plaintext=AES.new(passphrase,AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> plaintext.encrypt(decrypted)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analysisCGHeader</span><span class="params">(cg_content,cgPosition_content,aesIV,aesKey)</span>:</span></span><br><span class="line"></span><br><span class="line">	rename = <span class="string">"Invicsfate"</span></span><br><span class="line">	renameIndex = <span class="number">0</span></span><br><span class="line">	position = <span class="number">0x0</span></span><br><span class="line">	<span class="keyword">while</span> (position &lt;= <span class="number">0xD450</span>):</span><br><span class="line">		cipher = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">		position += <span class="number">1</span></span><br><span class="line">		fileNameLength = cgPosition_content[position:position+<span class="number">2</span>]</span><br><span class="line">		position += <span class="number">2</span></span><br><span class="line">		fileNameLength = struct.unpack(<span class="string">"&lt;H"</span>,fileNameLength)[<span class="number">0</span>]</span><br><span class="line">		fileName = cgPosition_content[position:position+fileNameLength]</span><br><span class="line">		position += fileNameLength</span><br><span class="line"></span><br><span class="line">		position += <span class="number">4</span></span><br><span class="line">		position += <span class="number">32</span></span><br><span class="line">		position += <span class="number">4</span></span><br><span class="line">		pngPosition = cgPosition_content[position:position+<span class="number">4</span>]</span><br><span class="line">		pngPosition = struct.unpack(<span class="string">"&lt;I"</span>,pngPosition)[<span class="number">0</span>]</span><br><span class="line">		position += <span class="number">4</span></span><br><span class="line">		position += <span class="number">4</span></span><br><span class="line">		pngSize = cgPosition_content[position:position+<span class="number">4</span>]</span><br><span class="line">		pngSize = struct.unpack(<span class="string">"&lt;I"</span>,pngSize)[<span class="number">0</span>]</span><br><span class="line">		position += <span class="number">4</span></span><br><span class="line">		position += <span class="number">8</span></span><br><span class="line"></span><br><span class="line">		cipher += aesIV</span><br><span class="line">		cipher += cg_content[pngPosition:pngPosition+pngSize]</span><br><span class="line"></span><br><span class="line">		length = len(cipher)</span><br><span class="line">		pundding=length%<span class="number">16</span></span><br><span class="line">		<span class="keyword">if</span> (pundding):</span><br><span class="line">			cipher += ((<span class="number">16</span> - pundding) * <span class="string">'\x00'</span>)</span><br><span class="line">		pngContent = decrypt(cipher, aesKey)</span><br><span class="line"></span><br><span class="line">		fileDictory = fileName[:fileName.rindex(<span class="string">'/'</span>)]</span><br><span class="line">		isReadable = fileName[fileName.rindex(<span class="string">'/'</span>)+<span class="number">1</span>:fileName.rindex(<span class="string">'/'</span>)+<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">		isExists = os.path.exists(fileDictory)</span><br><span class="line">		<span class="keyword">if</span> isExists:</span><br><span class="line">			<span class="keyword">if</span> ((ord(isReadable) &lt; <span class="number">0x20</span>) <span class="keyword">or</span> (ord(isReadable) &gt; <span class="number">0x7E</span>)):<span class="comment">#处理不可见文件名</span></span><br><span class="line">				fileName = fileDictory + <span class="string">"/"</span> + rename + str(renameIndex) + <span class="string">".png"</span></span><br><span class="line">			savePng = open(fileName,<span class="string">"wb"</span>)</span><br><span class="line">			savePng.write(pngContent)</span><br><span class="line">			savePng.close()</span><br><span class="line">			renameIndex += <span class="number">1</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">if</span> ((ord(isReadable) &lt; <span class="number">0x20</span>) <span class="keyword">or</span> (ord(isReadable) &gt; <span class="number">0x7E</span>)):<span class="comment">#处理不可见文件名</span></span><br><span class="line">				fileName = fileDictory + <span class="string">"/"</span> + rename + str(renameIndex) + <span class="string">".png"</span></span><br><span class="line">			os.makedirs(fileDictory)</span><br><span class="line">			savePng = open(fileName,<span class="string">"wb"</span>)</span><br><span class="line">			savePng.write(pngContent)</span><br><span class="line">			savePng.close()</span><br><span class="line">			renameIndex += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cg_fp = open(<span class="string">"cg.npk"</span>,<span class="string">'rb'</span>)</span><br><span class="line">cg_content = cg_fp.read()</span><br><span class="line"></span><br><span class="line">aesIV = getIV(cg_content)</span><br><span class="line"></span><br><span class="line">uiAesKey = [<span class="number">0x3C1FB7D0</span>,<span class="number">0xCFCE244E</span>,<span class="number">0x1DA9EEDD</span>,<span class="number">0x3240B024</span>,<span class="number">0x33E5A329</span>,<span class="number">0x8251290D</span>,<span class="number">0xC9D65160</span>,<span class="number">0x54AFF54A</span>]</span><br><span class="line">aesKey = getSecretKey(uiAesKey)</span><br><span class="line"></span><br><span class="line">cgPosition_fp = open(<span class="string">"testNPKCG"</span>,<span class="string">'rb'</span>)</span><br><span class="line"></span><br><span class="line">cgPosition_content = cgPosition_fp.read()</span><br><span class="line"></span><br><span class="line">cgPosition_fp.close()</span><br><span class="line"></span><br><span class="line">analysisCGHeader(cg_content,cgPosition_content,aesIV,aesKey)</span><br><span class="line"></span><br><span class="line">cg_fp.close()</span><br></pre></td></tr></table></figure>
<p>其中cg.npk是存储cg相关的npk文件，testNPKCG是解密出来的0xD460大小的文件描述结构。</p>
<p>该游戏目录下其他的npk文件，比如font.npk，system.npk等等都是使用该种模式加密，用同样的方式可以获取到所有npk文件的内容。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://Invicsfate.github.io/2019/05/31/打包小工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Invicsfate">
      <meta itemprop="description" content="如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Invicsfate">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/31/打包小工具/" class="post-title-link" itemprop="url">打包解包小工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-05-31 10:30:34 / Modified: 10:30:37" itemprop="dateCreated datePublished" datetime="2019-05-31T10:30:34+08:00">2019-05-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>目的效果：打包程序selfCompress.exe将指定目录下的所有文件以及文件夹打包成一个文件，由于程序逻辑均可逆向，所以仅对文件名以及文件内容进行了xor encode。将解包程序selfDecompress.exe以及打包好后的文件babyCompress.fate放在同一目录下，运行selfDecompress.exe即可解包，不能二次解包同一文件babyCompress.fate，除非修改babyCompress.fate偏移16处的标志位1为0，且需要删除*.fate文件(打包时没有设置.fate文件则无所谓)，因为*.fate设置了隐藏以及系统保护属性。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//selfCompress.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"header.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#pragma pack(1) 如果修改该结构体，可使用强制内存1字节对齐</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	DWORD structLength;</span><br><span class="line">	DWORD nameLength;</span><br><span class="line">	WORD secretKey;</span><br><span class="line">	BYTE targetAttribute;</span><br><span class="line">	BYTE depth;</span><br><span class="line">	<span class="keyword">char</span> targetName[<span class="number">0</span>];</span><br><span class="line">&#125;targetAttrs;</span><br><span class="line"><span class="comment">//#pragma pack()</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">compressFile</span><span class="params">(<span class="keyword">char</span>* outputFile,BYTE depth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD dwAttrs = GetFileAttributesA(outputFile);</span><br><span class="line">	<span class="keyword">if</span> (dwAttrs == INVALID_FILE_ATTRIBUTES)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Error %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dwAttrs &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> len = <span class="built_in">strlen</span>(<span class="built_in">strrchr</span>(outputFile, <span class="number">0x5C</span>) + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">int</span> totalSize = <span class="keyword">sizeof</span>(targetAttrs) + len + <span class="number">1</span>;</span><br><span class="line">		targetAttrs* compressTarget = (targetAttrs*)<span class="built_in">malloc</span>(totalSize);</span><br><span class="line">		<span class="built_in">memset</span>(compressTarget, <span class="number">0</span>, totalSize);</span><br><span class="line"></span><br><span class="line">		compressTarget-&gt;structLength = totalSize;</span><br><span class="line">		compressTarget-&gt;depth = depth;</span><br><span class="line">		compressTarget-&gt;nameLength = len;</span><br><span class="line">		compressTarget-&gt;secretKey = <span class="number">0x99</span>;</span><br><span class="line">		compressTarget-&gt;targetAttribute |= <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(compressTarget-&gt;targetName, <span class="built_in">strrchr</span>(outputFile, <span class="number">0x5C</span>) + <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* xor encode directory name */</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetName[i] ^= compressTarget-&gt;secretKey;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* xor encode directory name */</span></span><br><span class="line"></span><br><span class="line">		FILE *fp = fopen(FILENAME, <span class="string">"ab+"</span>);</span><br><span class="line">		<span class="keyword">if</span> (fp == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line">		fwrite(compressTarget, <span class="number">1</span>, totalSize, fp);</span><br><span class="line">		fclose(fp);</span><br><span class="line">		fp = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="built_in">free</span>(compressTarget);</span><br><span class="line">		compressTarget = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> len = <span class="built_in">strlen</span>(<span class="built_in">strrchr</span>(outputFile, <span class="number">0x5C</span>) + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">int</span> totalSize = <span class="keyword">sizeof</span>(targetAttrs) + len + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">char</span>* pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">		DWORD dwLength = <span class="number">0</span>;</span><br><span class="line">		targetAttrs* compressTarget = (targetAttrs*)<span class="built_in">malloc</span>(totalSize);</span><br><span class="line">		<span class="keyword">if</span> (!compressTarget)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(compressTarget, <span class="number">0</span>, totalSize);</span><br><span class="line"></span><br><span class="line">		compressTarget-&gt;structLength = totalSize;</span><br><span class="line">		compressTarget-&gt;depth = depth;</span><br><span class="line">		compressTarget-&gt;nameLength = len;</span><br><span class="line">		compressTarget-&gt;secretKey = <span class="number">0x23</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(compressTarget-&gt;targetName, <span class="built_in">strrchr</span>(outputFile, <span class="number">0x5C</span>) + <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* xor encode file name */</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetName[i] ^= compressTarget-&gt;secretKey;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* xor encode file name */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span>* suffix = <span class="built_in">strrchr</span>(outputFile, <span class="number">0x2e</span>);</span><br><span class="line">		<span class="keyword">if</span> (!suffix)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Error: can't find the file suffix.\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(suffix, <span class="string">".txt"</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetAttribute |= <span class="number">0x2</span>; <span class="comment">//代码复用原因：可能每个后缀名不同的文件会有不同的处理</span></span><br><span class="line">			FILE* txtFp = fopen(outputFile, <span class="string">"rb+"</span>);</span><br><span class="line">			fseek(txtFp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			dwLength = ftell(txtFp);</span><br><span class="line">			fseek(txtFp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, txtFp);</span><br><span class="line">				<span class="comment">/*read content and write*/</span></span><br><span class="line">			&#125;</span><br><span class="line">			fclose(txtFp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(suffix, <span class="string">".exe"</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetAttribute |= <span class="number">0x4</span>;</span><br><span class="line">			FILE* exeFp = fopen(outputFile, <span class="string">"rb+"</span>);</span><br><span class="line">			fseek(exeFp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			dwLength = ftell(exeFp);</span><br><span class="line">			fseek(exeFp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, exeFp);</span><br><span class="line">				<span class="comment">/*read content and write*/</span></span><br><span class="line">			&#125;</span><br><span class="line">			fclose(exeFp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*CTF*/</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(suffix, <span class="string">".fate"</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetAttribute |= <span class="number">16</span>;</span><br><span class="line">			FILE* fateFp = fopen(outputFile, <span class="string">"rb+"</span>);</span><br><span class="line">			fseek(fateFp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			dwLength = ftell(fateFp);</span><br><span class="line">			fseek(fateFp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, fateFp);</span><br><span class="line">				<span class="comment">/*read content and write*/</span></span><br><span class="line">			&#125;</span><br><span class="line">			fclose(fateFp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*CTF*/</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			compressTarget-&gt;targetAttribute |= <span class="number">0x8</span>;</span><br><span class="line">			FILE* otherFp = fopen(outputFile, <span class="string">"rb+"</span>);</span><br><span class="line">			fseek(otherFp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			dwLength = ftell(otherFp);</span><br><span class="line">			fseek(otherFp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, otherFp);</span><br><span class="line">				<span class="comment">/*read content and write*/</span></span><br><span class="line">			&#125;</span><br><span class="line">			fclose(otherFp);</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		FILE* fp = fopen(FILENAME, <span class="string">"ab+"</span>);</span><br><span class="line">		<span class="keyword">if</span> (fp == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line">		fwrite(compressTarget, <span class="number">1</span>, totalSize, fp);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* write content */</span></span><br><span class="line">		fwrite(&amp;dwLength, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">		<span class="keyword">if</span> (dwLength)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">/* xor encode file content */</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwLength; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				pBuffer[i] ^= compressTarget-&gt;secretKey;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* xor encode file content */</span></span><br><span class="line">			fwrite(pBuffer, <span class="number">1</span>, dwLength, fp);</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			fwrite(<span class="string">"\xff\xff\xff\xff"</span>, <span class="number">1</span>, <span class="number">4</span>, fp);<span class="comment">//end identifier</span></span><br><span class="line">		&#125;</span><br><span class="line">		fclose(fp);</span><br><span class="line">		fp = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="comment">/* write content */</span></span><br><span class="line">		<span class="built_in">free</span>(compressTarget);</span><br><span class="line">		<span class="built_in">free</span>(pBuffer);</span><br><span class="line">		compressTarget = <span class="literal">NULL</span>;</span><br><span class="line">		pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">doFile</span><span class="params">(<span class="keyword">char</span>* directory,BYTE depth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WIN32_FIND_DATAA findFileData;</span><br><span class="line">	<span class="keyword">char</span> tmpPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">	<span class="keyword">char</span> outputFile[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">	<span class="built_in">memcpy</span>(tmpPath, directory, <span class="built_in">strlen</span>(directory));</span><br><span class="line">	<span class="built_in">strcat</span>(tmpPath, <span class="string">"\\*"</span>);</span><br><span class="line">	HANDLE hFile = FindFirstFileA(tmpPath, &amp;findFileData);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Error %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strcmp</span>(findFileData.cFileName, <span class="string">"."</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(findFileData.cFileName, <span class="string">".."</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (findFileData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">				<span class="built_in">memcpy</span>(newPath, directory, <span class="built_in">strlen</span>(directory));</span><br><span class="line">				<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">				<span class="built_in">strcat</span>(newPath, findFileData.cFileName);</span><br><span class="line">				depth += <span class="number">1</span>;</span><br><span class="line">				compressFile(newPath, depth);</span><br><span class="line">				doFile(newPath,depth);</span><br><span class="line">				depth -= <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">memcpy</span>(outputFile, directory, <span class="built_in">strlen</span>(directory));</span><br><span class="line">				<span class="built_in">strcat</span>(outputFile, <span class="string">"\\"</span>);</span><br><span class="line">				<span class="built_in">strcat</span>(outputFile, findFileData.cFileName);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"%s depth:%d\n"</span>, outputFile,depth);</span><br><span class="line">				compressFile(outputFile,depth);</span><br><span class="line">				<span class="built_in">memset</span>(outputFile, <span class="number">0</span>, <span class="keyword">sizeof</span>(outputFile));</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (FindNextFileA(hFile, &amp;findFileData));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">createHeader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE *fp = fopen(FILENAME, <span class="string">"ab+"</span>);</span><br><span class="line"></span><br><span class="line">	DWORD dwHeaderSize = <span class="keyword">sizeof</span>(DWORD) + <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span> + <span class="keyword">sizeof</span>(COMPRESSMARK) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwHeaderSize + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwHeaderSize + <span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memcpy</span>(pBuffer, SIGNATURE, <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span>);</span><br><span class="line">	pBuffer += <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(pBuffer, &amp;dwHeaderSize, <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line">	pBuffer += <span class="keyword">sizeof</span>(DWORD);</span><br><span class="line">	<span class="built_in">memcpy</span>(pBuffer, COMPRESSMARK, <span class="keyword">sizeof</span>(COMPRESSMARK) - <span class="number">1</span>);</span><br><span class="line">	pBuffer += <span class="keyword">sizeof</span>(COMPRESSMARK) - <span class="number">1</span>;</span><br><span class="line">	pBuffer -= dwHeaderSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	fwrite(pBuffer, <span class="number">1</span>, dwHeaderSize, fp);</span><br><span class="line">	<span class="built_in">free</span>(pBuffer);</span><br><span class="line">	pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> dstPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Please Input Directory which will be compressed: "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%259s"</span>, dstPath);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create header */</span></span><br><span class="line">	<span class="keyword">if</span> (!createHeader())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Create Header Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* create header */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打包目录下所有的文件 */</span></span><br><span class="line">	doFile(dstPath,<span class="number">0</span>);</span><br><span class="line">	<span class="comment">/* 打包目录下所有的文件 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//header.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILENAME (<span class="meta-string">"babycompress.fate"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIGNATURE <span class="meta-string">"\x22\x33Invicsfate"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPRESSMARK <span class="meta-string">"\x00"</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//selfDecompress.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"header.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILENAME (<span class="meta-string">"babycompress.fate"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#pragma pack(1) 如果修改该结构体，可使用强制内存1字节对齐</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	DWORD structLength;</span><br><span class="line">	DWORD nameLength;</span><br><span class="line">	WORD secretKey;</span><br><span class="line">	BYTE targetAttribute;</span><br><span class="line">	BYTE depth;</span><br><span class="line">	<span class="keyword">char</span> targetName[<span class="number">0</span>];</span><br><span class="line">&#125;targetAttrs;</span><br><span class="line"><span class="comment">//#pragma pack()</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">decompressFile</span><span class="params">(<span class="keyword">char</span> *curPath,FILE *fp,BYTE depth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//FILE *fp = fopen(FILENAME, "ab+");</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		targetAttrs* decompressTarget = (targetAttrs*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(targetAttrs) + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (!decompressTarget)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(decompressTarget, <span class="number">0</span>, <span class="keyword">sizeof</span>(targetAttrs) + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (!fread(decompressTarget, <span class="number">1</span>, <span class="keyword">sizeof</span>(targetAttrs), fp))<span class="comment">//结束：1.读完 </span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">			decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"decompress Over!\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((decompressTarget-&gt;depth &lt; depth) || ((decompressTarget-&gt;depth == depth) &amp;&amp; (decompressTarget-&gt;targetAttribute &amp; <span class="number">0x1</span>)))<span class="comment">//结束：2.该层遍历完</span></span><br><span class="line">		&#123;</span><br><span class="line">			fseek(fp, -((<span class="keyword">signed</span> <span class="keyword">int</span>)<span class="keyword">sizeof</span>(targetAttrs)), SEEK_CUR);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"depth %d has been traversed!\n"</span>,depth);</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span>* targetName = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(decompressTarget-&gt;nameLength + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (!targetName)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(targetName, <span class="number">0</span>, decompressTarget-&gt;nameLength + <span class="number">1</span>);</span><br><span class="line">		fread(targetName, <span class="number">1</span>, decompressTarget-&gt;nameLength + <span class="number">1</span>, fp);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* xor encode directory or file name */</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; decompressTarget-&gt;nameLength; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			targetName[i] ^= decompressTarget-&gt;secretKey;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* xor encode directory or file name */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (decompressTarget-&gt;targetAttribute &amp; <span class="number">0x1</span>) <span class="comment">//directory</span></span><br><span class="line">		&#123;</span><br><span class="line">			depth = decompressTarget-&gt;depth;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">			<span class="built_in">memcpy</span>(newPath, curPath, <span class="built_in">strlen</span>(curPath));</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, targetName);</span><br><span class="line">			CreateDirectoryA(newPath, <span class="number">0</span>);</span><br><span class="line">			<span class="built_in">free</span>(targetName);</span><br><span class="line">			<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">			decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">			targetName = <span class="literal">NULL</span>;</span><br><span class="line">			decompressFile(newPath,fp,depth);</span><br><span class="line">			depth -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (decompressTarget-&gt;targetAttribute &amp; <span class="number">0x2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD dwLength = <span class="number">0</span>;</span><br><span class="line">			fread(&amp;dwLength, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">			<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">			<span class="built_in">memcpy</span>(newPath, curPath, <span class="built_in">strlen</span>(curPath));</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, targetName);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwLength + <span class="number">1</span>);</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, fp);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwLength; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					pBuffer[i] ^= decompressTarget-&gt;secretKey;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line"></span><br><span class="line">				FILE *txtFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">				fwrite(pBuffer, <span class="number">1</span>, dwLength,txtFp);</span><br><span class="line">				fclose(txtFp);</span><br><span class="line">				<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">				<span class="built_in">free</span>(pBuffer);</span><br><span class="line">				<span class="built_in">free</span>(targetName);</span><br><span class="line">				decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">				targetName = <span class="literal">NULL</span>;</span><br><span class="line">				pBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				DWORD endIndentifier = <span class="number">0</span>;</span><br><span class="line">				fread(&amp;endIndentifier, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">				<span class="keyword">if</span> (endIndentifier == <span class="number">0xffffffff</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					FILE* txtFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">					fclose(txtFp);</span><br><span class="line">					<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">					<span class="built_in">free</span>(targetName);</span><br><span class="line">					decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">					targetName = <span class="literal">NULL</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"decompress Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (decompressTarget-&gt;targetAttribute &amp; <span class="number">0x4</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD dwLength = <span class="number">0</span>;</span><br><span class="line">			fread(&amp;dwLength, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">			<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">			<span class="built_in">memcpy</span>(newPath, curPath, <span class="built_in">strlen</span>(curPath));</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, targetName);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwLength + <span class="number">1</span>);</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, fp);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwLength; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					pBuffer[i] ^= decompressTarget-&gt;secretKey;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line">				</span><br><span class="line">				FILE* exeFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">				fwrite(pBuffer, <span class="number">1</span>, dwLength, exeFp);</span><br><span class="line">				fclose(exeFp);</span><br><span class="line">				<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">				<span class="built_in">free</span>(pBuffer);</span><br><span class="line">				<span class="built_in">free</span>(targetName);</span><br><span class="line">				decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">				targetName = <span class="literal">NULL</span>;</span><br><span class="line">				pBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				DWORD endIndentifier = <span class="number">0</span>;</span><br><span class="line">				fread(&amp;endIndentifier, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">				<span class="keyword">if</span> (endIndentifier == <span class="number">0xffffffff</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					FILE* exeFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">					fclose(exeFp);</span><br><span class="line">					<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">					<span class="built_in">free</span>(targetName);</span><br><span class="line">					decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">					targetName = <span class="literal">NULL</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"decompress Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (decompressTarget-&gt;targetAttribute &amp; <span class="number">16</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD dwLength = <span class="number">0</span>;</span><br><span class="line">			fread(&amp;dwLength, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">			<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">			<span class="built_in">memcpy</span>(newPath, curPath, <span class="built_in">strlen</span>(curPath));</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, targetName);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwLength + <span class="number">1</span>);</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, fp);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwLength; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					pBuffer[i] ^= decompressTarget-&gt;secretKey;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line"></span><br><span class="line">				FILE* fateFp = fopen(newPath, <span class="string">"wb+"</span>); <span class="comment">//fopen无法打开受系统保护的隐藏文件</span></span><br><span class="line">				fwrite(pBuffer, <span class="number">1</span>, dwLength, fateFp);</span><br><span class="line">				fclose(fateFp);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/*CTF*/</span></span><br><span class="line">				<span class="keyword">if</span> (!SetFileAttributesA(newPath, FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_SYSTEM))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"SetFileAttributes Failed!%d\n"</span>, GetLastError());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/*CTF*/</span></span><br><span class="line">				<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">				<span class="built_in">free</span>(pBuffer);</span><br><span class="line">				<span class="built_in">free</span>(targetName);</span><br><span class="line">				decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">				targetName = <span class="literal">NULL</span>;</span><br><span class="line">				pBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				DWORD endIndentifier = <span class="number">0</span>;</span><br><span class="line">				fread(&amp;endIndentifier, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">				<span class="keyword">if</span> (endIndentifier == <span class="number">0xffffffff</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					FILE* exeFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">					fclose(exeFp);</span><br><span class="line">					<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">					<span class="built_in">free</span>(targetName);</span><br><span class="line">					decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">					targetName = <span class="literal">NULL</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"decompress Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (decompressTarget-&gt;targetAttribute &amp; <span class="number">0x8</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD dwLength = <span class="number">0</span>;</span><br><span class="line">			fread(&amp;dwLength, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">			<span class="keyword">char</span> newPath[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">			<span class="built_in">memcpy</span>(newPath, curPath, <span class="built_in">strlen</span>(curPath));</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, <span class="string">"\\"</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(newPath, targetName);</span><br><span class="line">			<span class="keyword">if</span> (dwLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwLength + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwLength + <span class="number">1</span>);</span><br><span class="line">				fread(pBuffer, <span class="number">1</span>, dwLength, fp);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwLength; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					pBuffer[i] ^= decompressTarget-&gt;secretKey;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/* xor encode file content */</span></span><br><span class="line"></span><br><span class="line">				FILE *otherFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">				fwrite(pBuffer, <span class="number">1</span>, dwLength,otherFp);</span><br><span class="line">				fclose(otherFp);</span><br><span class="line">				<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">				<span class="built_in">free</span>(pBuffer);</span><br><span class="line">				<span class="built_in">free</span>(targetName);</span><br><span class="line">				decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">				targetName = <span class="literal">NULL</span>;</span><br><span class="line">				pBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				DWORD endIndentifier = <span class="number">0</span>;</span><br><span class="line">				fread(&amp;endIndentifier, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">				<span class="keyword">if</span> (endIndentifier == <span class="number">0xffffffff</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					FILE* otherFp = fopen(newPath, <span class="string">"wb+"</span>);</span><br><span class="line">					fclose(otherFp);</span><br><span class="line">					<span class="built_in">free</span>(decompressTarget);</span><br><span class="line">					<span class="built_in">free</span>(targetName);</span><br><span class="line">					decompressTarget = <span class="literal">NULL</span>;</span><br><span class="line">					targetName = <span class="literal">NULL</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"decompress Error!\n"</span>);</span><br><span class="line">					<span class="keyword">return</span> FALSE;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">checkHeader</span><span class="params">(FILE* fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BYTE isCompress = <span class="number">0</span>;</span><br><span class="line">	DWORD dwCheckHeaderSize = <span class="number">0</span>;</span><br><span class="line">	DWORD dwHeaderSize = <span class="keyword">sizeof</span>(DWORD) + <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span> + <span class="keyword">sizeof</span>(COMPRESSMARK) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">char</span>* pBuffer = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(dwHeaderSize + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!pBuffer)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Allocate Memory Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(pBuffer, <span class="number">0</span>, dwHeaderSize + <span class="number">1</span>);</span><br><span class="line">	fread(pBuffer, <span class="number">1</span>, <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span>,fp);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pBuffer, SIGNATURE, <span class="keyword">sizeof</span>(SIGNATURE) - <span class="number">1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Check Signature Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	fread(&amp;dwCheckHeaderSize, <span class="number">1</span>, <span class="keyword">sizeof</span>(DWORD), fp);</span><br><span class="line">	<span class="keyword">if</span> (dwCheckHeaderSize != dwHeaderSize)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Check HeaderSize Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	fread(&amp;isCompress, <span class="number">1</span>, <span class="keyword">sizeof</span>(BYTE), fp);</span><br><span class="line">	<span class="keyword">if</span> (!isCompress)</span><br><span class="line">	&#123;</span><br><span class="line">		fseek(fp, <span class="number">-1</span>, SEEK_CUR);</span><br><span class="line">		fwrite(<span class="string">"\x01"</span>, <span class="number">1</span>, <span class="number">1</span>, fp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"babycompress.fate has been decompressed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pBuffer);</span><br><span class="line">	pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> dwHeaderSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//checkHeader();</span></span><br><span class="line">	<span class="keyword">char</span> path[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">	GetCurrentDirectoryA(MAX_PATH, path);</span><br><span class="line"></span><br><span class="line">	FILE* fp = fopen(FILENAME, <span class="string">"rb+"</span>);</span><br><span class="line">	</span><br><span class="line">	DWORD dwHeaderSize = checkHeader(fp);</span><br><span class="line">	<span class="keyword">if</span> (!dwHeaderSize)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Check Header Error!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(fp);</span><br><span class="line">	</span><br><span class="line">	fp = fopen(FILENAME, <span class="string">"ab+"</span>);</span><br><span class="line">	fseek(fp,dwHeaderSize,SEEK_SET);</span><br><span class="line">	decompressFile(path,fp,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//header.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILENAME (<span class="meta-string">"babycompress.fate"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIGNATURE <span class="meta-string">"\x22\x33Invicsfate"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPRESSMARK <span class="meta-string">"\x00"</span></span></span><br></pre></td></tr></table></figure>
<p>只是出CTF题目时的产物，挺有意思的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Invicsfate</p>
  <div class="site-description" itemprop="description">如果你喜欢，就把这一切当作是荣耀，而不是炫耀--by 叶修</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Invicsfate</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
